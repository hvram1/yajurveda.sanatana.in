---
import BaseLayout from '../../../../../layouts/BaseLayout.astro';
import SidebarTB from '../../../../../components/SidebarTB.astro';
import fs from 'fs';
import path from 'path';

export function getStaticPaths() {
  const metadataPath = path.join(process.cwd(), 'src/data/tb/metadata.json');
  const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'));
  
  const paths: { params: { prasna: string; prapaataka: string; anuvaka: string } }[] = [];
  for (const prasna of metadata.prasnas) {
    for (const prapaataka of prasna.prapatakas) {
      for (const anuvaka of prapaataka.anuvakas) {
        paths.push({
          params: { 
            prasna: String(prasna.prasna), 
            prapaataka: String(prapaataka.prapaataka),
            anuvaka: String(anuvaka.anuvaka)
          }
        });
      }
    }
  }
  return paths;
}

const { prasna, prapaataka, anuvaka } = Astro.params;
const prasnaNum = parseInt(prasna);
const prapaatakaNum = parseInt(prapaataka);
const anuvakaNum = parseInt(anuvaka);

const base = import.meta.env.BASE_URL;
const tbBase = `${base}tb/`;

// Load metadata for navigation
const metadataPath = path.join(process.cwd(), 'src/data/tb/metadata.json');
const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'));
const prasnaData = metadata.prasnas.find(p => p.prasna === prasnaNum);
const prapaatakaData = prasnaData?.prapatakas.find(pr => pr.prapaataka === prapaatakaNum);
const anuvakaData = prapaatakaData?.anuvakas.find(a => a.anuvaka === anuvakaNum);
const panchasatCount = anuvakaData?.panchasats || 0;

// Load Panchasat data
const panchasats = [];
for (let i = 1; i <= panchasatCount; i++) {
  const p = String(prasnaNum).padStart(2, '0');
  const pr = String(prapaatakaNum).padStart(2, '0');
  const a = String(anuvakaNum).padStart(2, '0');
  const ps = String(i).padStart(2, '0');
  const filePath = path.join(process.cwd(), `src/data/tb/${p}/${pr}/${a}/${ps}.json`);
  
  if (fs.existsSync(filePath)) {
    const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
    panchasats.push(data);
  }
}

const maxAnuvaka = prapaatakaData?.anuvakas.length || 0;
---

<BaseLayout title={`TB ${prasnaNum}.${prapaatakaNum}.${anuvakaNum}`} activeText="tb">
  <div class="page-with-sidebar">
    <SidebarTB currentPrasna={prasnaNum} currentPrapaataka={prapaatakaNum} currentAnuvaka={anuvakaNum} />
    <div class="main-content">
      <nav class="breadcrumb mb-6 text-sm">
        <a href={base}>मुख्यपृष्ठम्</a>
        <span class="mx-2">›</span>
        <a href={tbBase}>ब्राह्मण</a>
        <span class="mx-2">›</span>
        <a href={`${tbBase}prasna/${prasnaNum}`}>प्रश्नः {prasnaNum}</a>
        <span class="mx-2">›</span>
        <a href={`${tbBase}prapaataka/${prasnaNum}/${prapaatakaNum}`}>प्रपाठकः {prapaatakaNum}</a>
        <span class="mx-2">›</span>
        <span>अनुवाकः {anuvakaNum}</span>
      </nav>

      <div class="text-center mb-8">
        <h1 class="text-2xl text-indigo mb-2">TB {prasnaNum}.{prapaatakaNum}.{anuvakaNum}</h1>
        <p class="text-sm text-gray-500 mt-2">{panchasatCount} पञ्चाशत्</p>
      </div>

      <div class="fancy mb-8"><span>॥</span></div>

      {panchasats[0]?.anuvaka_header && (
        <div class="verse-card mb-6 text-center">
          <p class="text-lg sanskrit-text text-amber-700">{panchasats[0].anuvaka_header}</p>
        </div>
      )}

      <div class="space-y-6">
        {panchasats.map((ps, idx) => (
          <article class="verse-card" id={`panchasat-${idx + 1}`}>
            <header class="mb-3">
              <span class="text-lg font-semibold text-amber-600">{ps.header}</span>
            </header>
            <div class="sanskrit-text text-center text-gray-800 leading-relaxed">{ps.samhita}</div>
            {ps.korvai && (
              <details class="collapsible mt-4 border-t pt-4">
                <summary class="collapsible-header">
                  <span class="collapsible-icon">▶</span>
                  कोर्वै (Index)
                </summary>
                <div class="mt-3 text-sm text-gray-600 sanskrit-text">{ps.korvai}</div>
              </details>
            )}
          </article>
        ))}
      </div>

      <div class="flex justify-between mt-12 pt-4 border-t">
        {anuvakaNum > 1 ? (
          <a href={`${tbBase}anuvaka/${prasnaNum}/${prapaatakaNum}/${anuvakaNum - 1}`} class="nav-link bg-amber-50 rounded">← अनुवाकः {anuvakaNum - 1}</a>
        ) : (
          <a href={`${tbBase}prapaataka/${prasnaNum}/${prapaatakaNum}`} class="nav-link bg-amber-50 rounded">← प्रपाठकः {prapaatakaNum}</a>
        )}
        {anuvakaNum < maxAnuvaka ? (
          <a href={`${tbBase}anuvaka/${prasnaNum}/${prapaatakaNum}/${anuvakaNum + 1}`} class="nav-link bg-amber-50 rounded">अनुवाकः {anuvakaNum + 1} →</a>
        ) : (
          <a href={`${tbBase}prapaataka/${prasnaNum}/${prapaatakaNum}`} class="nav-link bg-amber-50 rounded">प्रपाठकः {prapaatakaNum} →</a>
        )}
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .page-with-sidebar { display: flex; min-height: calc(100vh - 200px); }
  .main-content { flex: 1; padding: 2rem; max-width: 900px; }
  @media (max-width: 768px) {
    .page-with-sidebar { flex-direction: column; }
    .main-content { padding: 1rem; }
  }
</style>
