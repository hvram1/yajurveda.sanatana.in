---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import SidebarTB from '../../../../components/SidebarTB.astro';
import fs from 'fs';
import path from 'path';

export function getStaticPaths() {
  const metadataPath = path.join(process.cwd(), 'src/data/tb/metadata.json');
  const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'));
  
  const paths: { params: { prasna: string; prapaataka: string } }[] = [];
  for (const prasna of metadata.prasnas) {
    for (const prapaataka of prasna.prapatakas) {
      paths.push({
        params: { 
          prasna: String(prasna.prasna), 
          prapaataka: String(prapaataka.prapaataka) 
        }
      });
    }
  }
  return paths;
}

const { prasna, prapaataka } = Astro.params;
const prasnaNum = parseInt(prasna);
const prapaatakaNum = parseInt(prapaataka);

const base = import.meta.env.BASE_URL;
const tbBase = `${base}tb/`;

// Load metadata
const metadataPath = path.join(process.cwd(), 'src/data/tb/metadata.json');
const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'));
const prasnaData = metadata.prasnas.find(p => p.prasna === prasnaNum);
const prapaatakaData = prasnaData?.prapatakas.find(pr => pr.prapaataka === prapaatakaNum);

const maxPrapaataka = prasnaData?.prapatakas.length || 0;
---

<BaseLayout title={`TB ${prasnaNum}.${prapaatakaNum}`} activeText="tb">
  <div class="page-with-sidebar">
    <SidebarTB currentPrasna={prasnaNum} currentPrapaataka={prapaatakaNum} />
    <div class="main-content">
      <nav class="breadcrumb mb-6 text-sm">
        <a href={base}>मुख्यपृष्ठम्</a>
        <span class="mx-2">›</span>
        <a href={tbBase}>ब्राह्मण</a>
        <span class="mx-2">›</span>
        <a href={`${tbBase}prasna/${prasnaNum}`}>प्रश्नः {prasnaNum}</a>
        <span class="mx-2">›</span>
        <span>प्रपाठकः {prapaatakaNum}</span>
      </nav>

      <div class="text-center mb-8">
        <h1 class="text-3xl text-indigo mb-2">प्रश्नः {prasnaNum} - प्रपाठकः {prapaatakaNum}</h1>
        <p class="text-gray-600">Prasna {prasnaNum}, Prapaataka {prapaatakaNum}</p>
        <p class="text-sm text-gray-500 mt-2">{prapaatakaData?.anuvakas.length} अनुवाकाः</p>
      </div>

      <div class="fancy mb-8"><span>॥</span></div>

      <section>
        <h2 class="text-xl text-indigo mb-6">अनुवाकाः (Anuvakas)</h2>
        <div class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-8 gap-3">
          {prapaatakaData?.anuvakas.map(anuvaka => (
            <a 
              href={`${tbBase}anuvaka/${prasnaNum}/${prapaatakaNum}/${anuvaka.anuvaka}`}
              class="verse-card text-center hover:shadow-lg transition-all py-3"
            >
              <div class="text-xl font-bold text-amber-600">{anuvaka.anuvaka}</div>
              <div class="text-xs text-gray-500 mt-1">{anuvaka.panchasats} पञ्चा°</div>
            </a>
          ))}
        </div>
      </section>

      <div class="flex justify-between mt-12 pt-4 border-t">
        {prapaatakaNum > 1 ? (
          <a href={`${tbBase}prapaataka/${prasnaNum}/${prapaatakaNum - 1}`} class="nav-link bg-amber-50 rounded">← प्रपाठकः {prapaatakaNum - 1}</a>
        ) : (
          <a href={`${tbBase}prasna/${prasnaNum}`} class="nav-link bg-amber-50 rounded">← प्रश्नः {prasnaNum}</a>
        )}
        {prapaatakaNum < maxPrapaataka ? (
          <a href={`${tbBase}prapaataka/${prasnaNum}/${prapaatakaNum + 1}`} class="nav-link bg-amber-50 rounded">प्रपाठकः {prapaatakaNum + 1} →</a>
        ) : (
          <a href={`${tbBase}prasna/${prasnaNum}`} class="nav-link bg-amber-50 rounded">प्रश्नः {prasnaNum} →</a>
        )}
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .page-with-sidebar { display: flex; min-height: calc(100vh - 200px); }
  .main-content { flex: 1; padding: 2rem; max-width: 900px; }
  @media (max-width: 768px) {
    .page-with-sidebar { flex-direction: column; }
    .main-content { padding: 1rem; }
  }
</style>
